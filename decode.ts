import { BAAL_ABI, IAVATAR_ABI, MULTISEND_ABI, WXDAI_ABI } from "./abis";
import { decodeMulti } from "ethers-multisend";
import { decodeFunctionDataWithInputs, logMultiSendActions } from "./helpers";

// proposal at https://admin.daohaus.fun/#/molochV3/0x64/0xf02fd4286917270cb94fbc13a0f4e1ed76f7e986/proposal/19

const proposalData = // from subgraph
  "0x8d80ff0a000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003d900f02fd4286917270cb94fbc13a0f4e1ed76f7e98600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000384b3c98bbb000000000000000000000000181ebdb03cb4b54f4020622f1b0eacd67a8c63ac0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002e4468721a7000000000000000000000000a238cbeb142c10ef7ad8442c6d1f9e89e07e776100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000002248d80ff0a000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001cb00e91d153e0b41518a2ce8dd3d7944fa863463a97d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000df1064632754674acb1b804f2c65849d016eaf9d00000000000000000000000000000000000000000000001b1ae4d6e2ef50000000e91d153e0b41518a2ce8dd3d7944fa863463a97d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000001e9c89aff77215f3ad26bffe0c50d4fdeba6a35200000000000000000000000000000000000000000000001b1ae4d6e2ef50000000e91d153e0b41518a2ce8dd3d7944fa863463a97d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000001a9cee6e1d21c3c09fb83a980ea54299f01920cd00000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

const proposalActions = decodeMulti(proposalData);

logMultiSendActions(proposalActions);

const data0 = proposalActions[0]?.data;

if (!data0) {
  throw new Error("data0 is undefined");
}

const result0 = decodeFunctionDataWithInputs({
  data: data0 as `0x${string}`,
  abi: BAAL_ABI,
});

console.log(JSON.stringify(result0, null, 2));

const data1 = result0?.args?.[2];

const found_data = // from UI
  "0x468721a7000000000000000000000000a238cbeb142c10ef7ad8442c6d1f9e89e07e776100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000002248d80ff0a000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001cb00e91d153e0b41518a2ce8dd3d7944fa863463a97d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000df1064632754674acb1b804f2c65849d016eaf9d00000000000000000000000000000000000000000000001b1ae4d6e2ef50000000e91d153e0b41518a2ce8dd3d7944fa863463a97d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000001e9c89aff77215f3ad26bffe0c50d4fdeba6a35200000000000000000000000000000000000000000000001b1ae4d6e2ef50000000e91d153e0b41518a2ce8dd3d7944fa863463a97d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000001a9cee6e1d21c3c09fb83a980ea54299f01920cd00000000000000000000000000000000000000000000001b1ae4d6e2ef50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

if (!data1) {
  throw new Error("data1 is undefined");
}

if (data1 !== found_data) {
  throw new Error("data1 is not equal to found_data");
}

const result1 = decodeFunctionDataWithInputs({
  data: data1 as `0x${string}`,
  abi: IAVATAR_ABI,
});

console.log(JSON.stringify(result1, null, 2));

const data2 = result1?.args?.[2];

if (!data2) {
  throw new Error("data2 is undefined");
}

const result2 = decodeFunctionDataWithInputs({
  data: data2 as `0x${string}`,
  abi: MULTISEND_ABI,
});

console.log(JSON.stringify(result2, null, 2));

const decodedActions = decodeMulti(data2 as `0x${string}`);

logMultiSendActions(decodedActions);

const decodedResult = decodedActions.map((d) => {
  const data3 = d.data;

  if (!data3) {
    throw new Error("data3 is undefined");
  }

  const result3 = decodeFunctionDataWithInputs({
    data: data3 as `0x${string}`,
    abi: WXDAI_ABI,
  });

  return result3;
});

console.log(JSON.stringify(decodedResult, null, 2));
